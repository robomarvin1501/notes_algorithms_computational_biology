name: Compile LaTeX to PDF (Cloudflare Pages)

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LaTeX
        run: |
          sudo apt-get update && sudo apt-get upgrade -y
          sudo apt-get install --fix-missing -y texlive texlive-latex-extra texlive-fonts-recommended texlive-lang-english texlive-luatex texlive-science texlive-fonts-extra texlive-bibtex-extra texlive-pictures texlive-xetex texlive-plain-generic

      - name: Compile LaTeX files
        run: |
          mkdir -p public
          for file in *.latex; do
            lualatex -interaction=nonstopmode -output-directory=public "$file"
          done

      - name: Generate index.html
        run: |
          echo "<html><head><title>Lecture Notes</title> ... (your HTML) ..." > public/index.html
          for file in $(ls public/*.pdf | sort -V); do
            filename=$(basename "$file")
            echo "<li><a href='$filename'>$filename</a></li>" >> public/index.html
          done
          echo "</ul></body></html>" >> public/index.html

      - name: Upload to Cloudflare Pages
        run: |
          zip -r output.zip public
          curl -X POST "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/${{ secrets.CF_PAGES_PROJECT }}/deployments" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -F "metadata={\"source\":\"github-actions\"};type=application/json" \
            -F "bundle=@output.zip"
